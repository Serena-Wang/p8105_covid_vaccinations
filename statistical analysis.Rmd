---
title: "Statistical Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
  always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(mgcv)
```

From the previous data exploration, visualization and analysis process, we notice that several geographical and demographic factors may have a direct influence on the overall vaccination rate in NYC. Here we want to dig deeper into the data set and form the statistical relationship between vaccination rate and the spatial & social indicators. We conducted chi-square tests to examine the significant predictors among borough, race, age, and gender in determining the vaccination rate in NYC. We then built statistical models between selected factors and the fully vaccination rate in NYC

## Description of Dataset:

* The Coverage_by_Boro dataset contains the absolute counts and estimated percentage of NYC residents vaccinated for COVID-19. People are stratified by age, race/ethnicity, gender, or geographical locations.  For each group, the observations were further divided into subgroups. Vaccination results by specific demographic category or geographical areas were recorded by day. We selected vaccination rate rather than counts as the target variable adjusting for the different group size. We used this dataset to select the predictors.
  - Target variable 1: percentage of partially vaccinated - the estimated proportion of the population partially vaccinated by the indicated subgroup 
  - Target variable 2: percentage of fully vaccinated -  the estimated percentage of the population who completed the major series of Covid vaccination in the subgroup
  - Target variable 3: percentage of addition vaccinated: the estimated proportion of the population with additional/ booster vaccination by the indicated subgroup
\All three measurements are cumulative.

* The Coverage_demo_full data set contains the number and percentage of NYC residents vaccinated for COVID-19. People are categorized by both age and race/ethnicity. We selected the percentage of fully vaccinated people as our target variable. We used this dataset to fit the model.
  - Target Variable in model fitting : percentage of fully vaccinated -  the estimated percentage of the population who completed the major series of Covid vaccination in the subgroup


## Selection of Predictors and Data Cleaning

The first dataset is stratified by age, race/ethnicity, gender, or geographical locations.
```{r, message = FALSE}
stratified = 
  read_csv("https://raw.githubusercontent.com/Serena-Wang/p8105_covid_vaccinations/main/Data/coverage_by_demo_full.csv") %>%
  janitor::clean_names() %>%
  select(group, subgroup, perc_partially, perc_fully, perc_additional) %>%
  drop_na()

knitr::kable(head(stratified), digits = 3)
```

The second dataset take
```{r, message = FALSE}
unstratified = 
  read_csv("https://raw.githubusercontent.com/Serena-Wang/p8105_covid_vaccinations/main/Data/coverage_boro_demo_full.csv") %>%
  janitor::clean_names() %>%
  select(age_group, race_ethnicity, city_perc_fully) %>%
  filter(
    !age_group %in% c("Boroughwide", "All ages", "65+", "13-17", "18-44", "45-64") 
)

knitr::kable(head(unstratified), digits = 3)
```

## Chi-square Test 

### Boroughs

We predicted that there is no difference in vaccination rate in NYC across the six boroughs. We will perform the chi-square test to verify our assumption.

H0: the expected vaccination rates are the same across all boroughs.

H1: the expected vaccination rate are not same across all boroughs.

```{r, message = FALSE}
demo_boro = 
  stratified %>%
  filter(group == "Borough") %>% 
  select(-group) %>%
  group_by(subgroup) %>%
  summarise(
    partial_vaccin = mean(perc_partially),
    full_vaccin = mean(perc_fully),
    additional_vaccin = mean(perc_additional)) %>%
  filter(subgroup != "Citywide") %>%
  select(-subgroup) %>%
  data.matrix()

rownames(demo_boro) = c("Bronx", "Brooklyn", "Manhattan", "Queens", "Staten Island")

knitr::kable(demo_boro, digits = 3)
```

```{r, message = FALSE}
chisq.test(demo_boro)
```

Interpretation: The result of chi-square shows that χ2<χcrit, at significant level α=0.05, so we fail to reject the null hypothesis and conclude that the vaccination rate is same across all boroughs.

### Race

We predicted that there is no difference in vaccination rate in NYC across the six types of race. We will perform the chi-square test to verify our assumption.

H0: the expected vaccination rates are the same across all races.

H1: the expected vaccination rates are not same across all races.

```{r, message = FALSE}
demo_race = 
  stratified %>%
  filter(group == "Race/ethnicity") %>%
  filter(
    perc_partially < 100,
    perc_fully < 100,
    perc_additional < 100
  ) %>%
  select(-group) %>%
  group_by(subgroup) %>%
  summarise(
    partial_vaccin = mean(perc_partially),
    full_vaccin = mean(perc_fully),
    additional_vaccin = mean(perc_additional)) %>%
  filter(subgroup != "Native American/Alaska Native") %>%
  select(-subgroup) %>%
  data.matrix()

rownames(demo_race) = c("Asian", "Black", "Hispanic/Latino", "Multiracial","White")

knitr::kable(demo_race, digit = 3)
```

```{r, message = FALSE}
chisq.test(demo_race)
```

Interpretation: The result of chi-square shows that χ2<χcrit, at significant level α=0.05, so we fail to reject the null hypothesis and conclude that the vaccination rate is same across races.

### Sex

We predicted that there is no difference in vaccination rate in NYC across genders. We will perform the chi-square test to verify our assumption.

H0: the expected vaccination rates are the same across genders.

H1: the expected vaccination rates are not same across all genders.

```{r, message = FALSE}
demo_sex = 
  stratified %>%
  filter(group == "Sex") %>%
  select(-group) %>%
  group_by(subgroup) %>%
  summarise(
    partial_vaccin = mean(perc_partially),
    full_vaccin = mean(perc_fully),
    additional_vaccin = mean(perc_additional)) %>%
  select(-subgroup) %>%
  data.matrix()

rownames(demo_sex) = c("Female", "Male")

knitr::kable(demo_sex)
```

```{r, message = FALSE}
chisq.test(demo_sex)
```

Interpretation: The result of chi-square shows that χ2<χcrit, at significant level α=0.05, so we fail to reject the null hypothesis and conclude that the vaccination rate is same for male and female.

### Age

We predicted that there is no difference in vaccination rate in NYC across differenc age groups. We will perform the chi-square test to verify our assumption.

H0: the expected vaccination rates are the same across age groups.

H1: the expected vaccination rate are not same across age groups.

```{r, message = FALSE}
demo_age = 
  stratified %>%
  filter(
    group == "Age",
    subgroup != "'5-12",
    subgroup != "'0-4",
    subgroup != "'13-17") %>%
  select(-group) %>% 
  group_by(subgroup) %>%
  summarise(
    partial_vaccin = mean(perc_partially),
    full_vaccin = mean(perc_fully),
    additional_vaccin = mean(perc_additional)) %>%
  select(-subgroup) %>%
  data.matrix() 

rownames(demo_age) = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75-84", "85+")

knitr::kable(demo_age, digits = 3)
```

```{r, message = FALSE}
chisq.test(demo_age)
```

Interpretation: The result of chi-square shows that χ2>χcrit, at significant level α=0.05, so we reject the null hypothesis and conclude that the vaccination rate is not same for difference age groups. \

Conclusion: according to the results of chi-square test, we can conclude that age is the most significant predictor of the vaccination rate in NYC. However, race has the second lowest p-value, so we will fit the model with these two predictors.

